<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shqip365 - Ndeshjet</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>Shqip365</header>

  <div class="tabs">
    <div class="tab" onclick="navigate('live')">Live</div>
    <div class="tab active" onclick="loadMatches('upcoming')">SÃ« Shpejti</div>
    <div class="tab" onclick="loadMatches('finished')">PÃ«rfunduar</div>
  </div>

  <div class="filters" id="leagueFilters"></div>

  <div class="matches" id="matches">
    <div class="loading">Po ngarkohen ndeshjet...</div>
  </div>

  <script>
    let allMatches = [];
    let currentType = 'upcoming';
    let refreshInterval;

    function navigate(type) {
      window.location.href = type === 'live' ? '/' : `/matches?type=${type}`;
    }

    async function loadMatches(type) {
      currentType = type;
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelector(`.tab[onclick="loadMatches('${type}')"]`).classList.add("active");

      const container = document.getElementById("matches");
      container.innerHTML = `<div class="loading">Po ngarkohen ndeshjet...</div>`;

      try {
        let res = await fetch(`/matches?type=${type}`);
        let data = await res.json();

        if ((!data.response || data.response.length === 0) && type === 'upcoming') {
          const tomorrow = new Date();
          tomorrow.setDate(tomorrow.getDate() + 1);
          const formattedDate = tomorrow.toISOString().split('T')[0];
          res = await fetch(`/matches?type=upcoming&date=${formattedDate}`);
          data = await res.json();
        }

        if (!data.response || data.response.length === 0) {
          container.innerHTML = `<div class="loading">Nuk ka ndeshje tÃ« planifikuara âš½</div>`;
          return;
        }

        allMatches = data.response;
        renderLeagues(allMatches);
        renderMatchesGrouped(allMatches);

        clearInterval(refreshInterval);
        refreshInterval = setInterval(() => loadMatches(currentType), 60000);
      } catch (e) {
        container.innerHTML = `<div class="loading">Gabim gjatÃ« ngarkimit tÃ« ndeshjeve âš ï¸</div>`;
      }
    }

    function renderLeagues(matches) {
      const leagues = [...new Set(matches.map(m => m.league.name))];
      const div = document.getElementById("leagueFilters");
      div.innerHTML = `<div class="filter-btn active" onclick="filterLeague('all')">TÃ« gjitha</div>`;
      leagues.forEach(league => {
        div.innerHTML += `<div class="filter-btn" onclick="filterLeague('${league}')">${league}</div>`;
      });
    }

    function renderMatchesGrouped(matches) {
      const container = document.getElementById("matches");
      container.innerHTML = "";

      const grouped = matches.reduce((acc, match) => {
        const date = new Date(match.fixture.date).toLocaleDateString("sq-AL", { day: "2-digit", month: "long", year: "numeric" });
        if (!acc[date]) acc[date] = [];
        acc[date].push(match);
        return acc;
      }, {});

      for (const [date, games] of Object.entries(grouped)) {
        container.innerHTML += `<h3 class="match-date">ğŸ“… ${date}</h3>`;
        games.forEach(m => {
          const f = m.fixture;
          const t = m.teams;
          const g = m.goals;
          const l = m.league;

          const time = new Date(f.date).toLocaleTimeString("sq-AL", { hour: "2-digit", minute: "2-digit" });
          const status = f.status?.short === "FT" ? "PÃ«rfunduar" :
                        f.status?.short === "NS" ? "SÃ« shpejti" :
                        f.status?.short?.includes("'") ? `${f.status.short} min` : "Live";

          container.innerHTML += `
            <div class="match" data-league="${l.name}">
              <div class="teams">
                <div class="team"><img src="${t.home.logo}" alt=""><span>${t.home.name}</span></div>
                <div class="score">${g.home ?? 0} - ${g.away ?? 0}</div>
                <div class="team" style="justify-content: flex-end;">
                  <span>${t.away.name}</span><img src="${t.away.logo}" alt="">
                </div>
              </div>
              <div class="info">${l.name} â€¢ ${time} â€¢ ${status}</div>
            </div>
          `;
        });
      }
    }

    function filterLeague(league) {
      document.querySelectorAll(".filter-btn").forEach(btn => btn.classList.remove("active"));
      const active = Array.from(document.querySelectorAll(".filter-btn"))
        .find(b => b.textContent === league || (league === "all" && b.textContent === "TÃ« gjitha"));
      if (active) active.classList.add("active");

      const filtered = league === "all" ? allMatches : allMatches.filter(m => m.league.name === league);
      renderMatchesGrouped(filtered);
    }

    loadMatches('upcoming');
  </script>
</body>
</html>
<script>
async function loadUpcomingMatches() {
  const container = document.querySelector('.matches');
  container.innerHTML = '<div class="loading">Duke ngarkuar ndeshjet e ardhshme...</div>';

  try {
    const response = await fetch('https://v3.football.api-sports.io/fixtures?date=2025-11-11', {
      method: 'GET',
      headers: {
        'x-apisports-key': 'VENDOS_KODIN_TÃ‹ND_API_KÃ‹TU'
      }
    });
    const data = await response.json();

    if (!data.response || data.response.length === 0) {
      container.innerHTML = '<div class="loading">Nuk ka ndeshje sÃ« shpejti.</div>';
      return;
    }

    container.innerHTML = ''; // pastro
    let currentDate = '';

    data.response.forEach(match => {
      const date = new Date(match.fixture.date).toLocaleDateString('sq-AL', {
        day: 'numeric', month: 'long', year: 'numeric'
      });

      if (date !== currentDate) {
        currentDate = date;
        container.innerHTML += `<div class="match-date">ğŸ“… ${date}</div>`;
      }

      const home = match.teams.home;
      const away = match.teams.away;
      const league = match.league.name;
      const country = match.league.country;

      container.innerHTML += `
        <div class="match">
          <div class="info">${league} - ${country}</div>
          <div class="teams">
            <div class="team">
              <img src="${home.logo}" alt="${home.name}">
              <span>${home.name}</span>
            </div>
            <div class="score">VS</div>
            <div class="team">
              <img src="${away.logo}" alt="${away.name}">
              <span>${away.name}</span>
            </div>
          </div>
        </div>`;
    });
  } catch (error) {
    console.error(error);
    container.innerHTML = '<div class="loading">Gabim gjatÃ« ngarkimit tÃ« ndeshjeve.</div>';
  }
}

loadUpcomingMatches();
</script>
